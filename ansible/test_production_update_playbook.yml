- name: Change production version
  hosts: staging
  vars_prompt:
    - name: target_version
      prompt: "Enter the version/tag to update to"
      private: false

  tasks:
    - name: Update packages
      become: true
      ansible.builtin.apt:
        update_cache: yes
        upgrade: safe
        autoremove: true

    - name: Ensure needrestart is installed
      become: true
      ansible.builtin.apt:
        name: needrestart
        state: present
        update_cache: yes

    - name: Check if reboot is required
      shell:
        cmd: needrestart -b | awk '/NEEDRESTART-KEXP|NEEDRESTART-KCUR/ {print $2}'
      become: true
      register: reboot_required_file

    - name: Reboot if required
      reboot:
        msg: "Rebooting due to system updates"
        connect_timeout: 5
        reboot_timeout: 360
        pre_reboot_delay: 0
        post_reboot_delay: 30
        test_command: uptime
      become: true
      when: reboot_required_file.stdout_lines[0] != reboot_required_file.stdout_lines[1]

# Check .env file for missing keys
    - name: Fetch .env.example from target version
      ansible.builtin.uri:
        url: "https://raw.githubusercontent.com/Tinkerforge/esp32-remote-access/{{ target_version }}/docker/.env.example"
        return_content: yes
      register: env_example_response

    - name: Set .env.example content
      ansible.builtin.set_fact:
        env_example_content: "{{ env_example_response.content }}"

    - name: Read .env from home directory
      ansible.builtin.slurp:
        src: "/home/{{ ansible_user_id }}/remote_access/.env"
      register: env_content

    - name: Extract keys from .env.example
      ansible.builtin.set_fact:
        env_example_keys: "{{ env_example_content.split('\n') | select('match', '^[A-Za-z_][A-Za-z0-9_]*=') | map('regex_replace', '=.*', '') | list }}"

    - name: Extract keys from .env
      ansible.builtin.set_fact:
        env_keys: "{{ (env_content.content | b64decode).split('\n') | select('match', '^[A-Za-z_][A-Za-z0-9_]*=') | map('regex_replace', '=.*', '') | list }}"

    - name: Find missing keys in .env
      ansible.builtin.set_fact:
        missing_keys: "{{ env_example_keys | difference(env_keys) }}"

    - name: Fail if there are missing keys in .env
      ansible.builtin.fail:
        msg: "Missing keys in .env compared to .env.example: {{ missing_keys | join(', ') }}"
      when: missing_keys | length > 0

# end check .env file for missing keys

    - name: Update IMAGE_TAG in .env file
      ansible.builtin.lineinfile:
        path: "/home/{{ ansible_user_id }}/remote_access/.env"
        regexp: '^IMAGE_TAG='
        line: "IMAGE_TAG={{ target_version }}"
        state: present

    - name: Update docker-compose.yml from repository
      ansible.builtin.get_url:
        url: https://raw.githubusercontent.com/Tinkerforge/esp32-remote-access/{{ target_version }}/docker/docker-compose.yml
        dest: "/home/{{ ansible_user_id }}/remote_access/docker-compose.yml"
        mode: '0644'
        force: yes
      register: compose_update

    - name: Show docker-compose update status
      ansible.builtin.debug:
        msg: "docker-compose.yml updated: {{ compose_update.changed }}"

    - name: checkout warp-charger git
      ansible.builtin.git:
        repo: https://github.com/Tinkerforge/warp-charger.git
        dest: "/home/{{ ansible_user_id }}/remote_access/warp-charger"
        version: master
        update: yes
        clone: yes
        depth: 1

    - name: Pull and rerun docker images
      community.docker.docker_compose_v2:
        build: always
        pull: always
        project_src: "/home/{{ ansible_user_id }}/remote_access"

    - name: Prune unused Docker containers
      community.docker.docker_prune:
        containers: yes

    - name: Ensure scripts directory exists
      ansible.builtin.file:
        path: "/home/{{ ansible_user_id }}/remote_access/scripts"
        state: directory
        mode: '0755'

    - name: Download backup script from repository
      ansible.builtin.get_url:
        url: https://raw.githubusercontent.com/Tinkerforge/esp32-remote-access/{{ target_version }}/scripts/backup_database.sh
        dest: "/home/{{ ansible_user_id }}/remote_access/scripts/backup_database.sh"
        mode: '0755'
        force: yes

    - name: Setup daily database backup cronjob
      ansible.builtin.cron:
        name: "Daily database backup"
        minute: "0"
        hour: "3"
        job: "/home/{{ ansible_user_id }}/remote_access/scripts/backup_database.sh"
        user: "{{ ansible_user_id }}"

    - name: Show current tag
      ansible.builtin.debug:
        msg: "Checked out tag: {{ git_tag.stdout | default('none') }}"
